<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Didactic Synthesizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .knob {
            background: conic-gradient(from 0deg, #e5e7eb 0deg, #5D5CDE 0deg, #e5e7eb 0deg);
            transition: all 0.1s ease;
        }
        .dark .knob {
            background: conic-gradient(from 0deg, #374151 0deg, #5D5CDE 0deg, #374151 0deg);
        }
        .key-white {
            background: linear-gradient(180deg, #fff 0%, #f3f4f6 100%);
            border: 1px solid #d1d5db;
        }
        .key-white:active, .key-white.active {
            background: linear-gradient(180deg, #e5e7eb 0%, #d1d5db 100%);
        }
        .key-black {
            background: linear-gradient(180deg, #374151 0%, #1f2937 100%);
        }
        .key-black:active, .key-black.active {
            background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
        }
        .dark .key-white {
            background: linear-gradient(180deg, #f9fafb 0%, #e5e7eb 100%);
            border: 1px solid #9ca3af;
        }
        .dark .key-white:active, .dark .key-white.active {
            background: linear-gradient(180deg, #d1d5db 0%, #9ca3af 100%);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 transition-colors duration-300">
    <div class="min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">Didactic Synthesizer</h1>
                <p class="text-gray-600 dark:text-gray-400">Learn sound synthesis by experimenting with oscillators, filters, and envelopes</p>
            </div>

            <!-- Main Synthesizer Interface -->
            <div class="bg-gray-100 dark:bg-gray-800 rounded-2xl p-6 shadow-xl">
                <!-- Waveform Display -->
                <div class="bg-black rounded-lg mb-6 p-4">
                    <canvas id="waveformCanvas" width="800" height="200" class="w-full h-auto"></canvas>
                </div>

                <!-- Control Sections -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Oscillator Section -->
                    <div class="bg-white dark:bg-gray-700 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Oscillator</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Waveform</label>
                                <select id="waveform" class="w-full p-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                                    <option value="sine">Sine - Pure tone</option>
                                    <option value="sawtooth">Sawtooth - Bright, rich harmonics</option>
                                    <option value="square">Square - Hollow, video game-like</option>
                                    <option value="triangle">Triangle - Soft, flute-like</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Detune (cents)</label>
                                <input type="range" id="detune" min="-100" max="100" value="0" class="w-full">
                                <span id="detuneValue" class="text-sm text-gray-600 dark:text-gray-400">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Section -->
                    <div class="bg-white dark:bg-gray-700 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Filter</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type</label>
                                <select id="filterType" class="w-full p-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                                    <option value="lowpass">Low Pass - Removes high frequencies</option>
                                    <option value="highpass">High Pass - Removes low frequencies</option>
                                    <option value="bandpass">Band Pass - Keeps middle frequencies</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cutoff Frequency</label>
                                <input type="range" id="cutoff" min="100" max="8000" value="2000" class="w-full">
                                <span id="cutoffValue" class="text-sm text-gray-600 dark:text-gray-400">2000 Hz</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Resonance (Q)</label>
                                <input type="range" id="resonance" min="0.1" max="30" value="1" step="0.1" class="w-full">
                                <span id="resonanceValue" class="text-sm text-gray-600 dark:text-gray-400">1.0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Envelope Section -->
                    <div class="bg-white dark:bg-gray-700 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Envelope (ADSR)</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Attack</label>
                                <input type="range" id="attack" min="0" max="2" value="0.1" step="0.01" class="w-full">
                                <span id="attackValue" class="text-sm text-gray-600 dark:text-gray-400">0.1s</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Decay</label>
                                <input type="range" id="decay" min="0" max="2" value="0.3" step="0.01" class="w-full">
                                <span id="decayValue" class="text-sm text-gray-600 dark:text-gray-400">0.3s</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sustain</label>
                                <input type="range" id="sustain" min="0" max="1" value="0.7" step="0.01" class="w-full">
                                <span id="sustainValue" class="text-sm text-gray-600 dark:text-gray-400">0.7</span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Release</label>
                                <input type="range" id="release" min="0" max="3" value="0.5" step="0.01" class="w-full">
                                <span id="releaseValue" class="text-sm text-gray-600 dark:text-gray-400">0.5s</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MIDI Controls -->
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">MIDI</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div id="midiStatus" class="w-3 h-3 rounded-full bg-red-500"></div>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Status: <span id="midiStatusText">Disconnected</span></span>
                            </div>
                            <button id="midiConnect" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm">
                                Connect MIDI
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">MIDI Input Device</label>
                            <select id="midiDevice" class="w-full p-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white" disabled>
                                <option value="">No devices available</option>
                            </select>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            <div class="mb-2"><strong>Native Instruments Z1 EQ Mapping:</strong></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <div>
                                    <div class="font-medium text-blue-600 dark:text-blue-400">Channel A EQ:</div>
                                    <div>HI → Filter Cutoff</div>
                                    <div>MID → Resonance</div>
                                    <div>LOW → Attack</div>
                                </div>
                                <div>
                                    <div class="font-medium text-green-600 dark:text-green-400">Channel B EQ:</div>
                                    <div>HI → Decay</div>
                                    <div>MID → Sustain</div>
                                    <div>LOW → Release</div>
                                </div>
                            </div>
                            <div class="mt-2 text-gray-400">Filter A → Detune | Gain A → Volume</div>
                        </div>
                        
                        <!-- MIDI Debug Monitor -->
                        <div class="mt-4 p-3 bg-gray-100 dark:bg-gray-600 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <div class="font-medium text-gray-700 dark:text-gray-300">MIDI Monitor</div>
                                <button id="clearMidiLog" class="text-xs px-2 py-1 bg-gray-300 dark:bg-gray-500 rounded hover:bg-gray-400 dark:hover:bg-gray-400">Clear</button>
                            </div>
                            <div id="midiLog" class="text-xs font-mono text-gray-600 dark:text-gray-300 h-20 overflow-y-auto bg-white dark:bg-gray-700 p-2 rounded border">
                                Move Z1 knobs to see MIDI messages here...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Master Volume -->
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Master Controls</h3>
                    <div class="flex items-center space-x-4">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Volume</label>
                        <input type="range" id="volume" min="0" max="1" value="0.3" step="0.01" class="flex-1">
                        <span id="volumeValue" class="text-sm text-gray-600 dark:text-gray-400 w-12">30%</span>
                    </div>
                </div>

                <!-- Piano Keyboard -->
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Keyboard</h3>
                    <div id="keyboard" class="relative flex justify-center overflow-x-auto">
                        <!-- Keys will be generated by JavaScript -->
                    </div>
                    <div class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400">
                        Click keys or use your computer keyboard (A-K for white keys, W-U for black keys)
                    </div>
                </div>
            </div>

            <!-- Educational Info -->
            <div class="mt-8 bg-blue-50 dark:bg-blue-900/20 rounded-xl p-6">
                <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-200 mb-4">How It Works</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800 dark:text-blue-300">
                    <div>
                        <h4 class="font-semibold mb-2">Oscillator</h4>
                        <p>Generates the basic waveform. Different shapes create different timbres - sine waves are pure, sawtooth waves are bright and buzzy.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Filter</h4>
                        <p>Shapes the sound by removing certain frequencies. Low-pass filters make sounds warmer, high-pass filters make them thinner.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Envelope</h4>
                        <p>Controls how the volume changes over time: Attack (fade in), Decay (initial drop), Sustain (held level), Release (fade out).</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Resonance</h4>
                        <p>Emphasizes frequencies near the filter cutoff, creating a more dramatic filtering effect and sometimes self-oscillation.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Audio Context and Synthesizer
        let audioContext;
        let masterGain;
        let analyser;
        let dataArray;
        const activeNotes = new Map();

        // Waveform visualization
        const canvas = document.getElementById('waveformCanvas');
        const canvasCtx = canvas.getContext('2d');

        // Initialize audio
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioContext.createGain();
                masterGain.gain.value = 0.3;
                
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                
                masterGain.connect(analyser);
                analyser.connect(audioContext.destination);
                
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                drawWaveform();
            }
        }

        // Note frequencies (A4 = 440Hz)
        const noteFrequencies = {
            'C': 261.63,
            'C#': 277.18,
            'D': 293.66,
            'D#': 311.13,
            'E': 329.63,
            'F': 349.23,
            'F#': 369.99,
            'G': 392.00,
            'G#': 415.30,
            'A': 440.00,
            'A#': 466.16,
            'B': 493.88
        };

        // Create keyboard
        function createKeyboard() {
            const keyboard = document.getElementById('keyboard');
            const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackKeys = ['C#', 'D#', null, 'F#', 'G#', 'A#', null];
            
            // Create white keys
            whiteKeys.forEach((note, index) => {
                const key = document.createElement('div');
                key.className = 'key-white relative w-12 h-32 cursor-pointer select-none';
                key.dataset.note = note;
                key.innerHTML = `<span class="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-xs text-gray-500">${note}</span>`;
                keyboard.appendChild(key);
                
                // Add event listeners
                key.addEventListener('mousedown', () => playNote(note));
                key.addEventListener('mouseup', () => stopNote(note));
                key.addEventListener('mouseleave', () => stopNote(note));
                key.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    playNote(note);
                });
                key.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    stopNote(note);
                });
            });
            
            // Create black keys
            blackKeys.forEach((note, index) => {
                if (note) {
                    const key = document.createElement('div');
                    key.className = 'key-black absolute w-8 h-20 cursor-pointer select-none z-10';
                    key.style.left = `${(index * 48) + 32}px`;
                    key.dataset.note = note;
                    keyboard.appendChild(key);
                    
                    // Add event listeners
                    key.addEventListener('mousedown', () => playNote(note));
                    key.addEventListener('mouseup', () => stopNote(note));
                    key.addEventListener('mouseleave', () => stopNote(note));
                    key.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        playNote(note);
                    });
                    key.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        stopNote(note);
                    });
                }
            });
        }

        // Play note
        function playNote(note) {
            initAudio();
            
            if (activeNotes.has(note)) return;
            
            const frequency = noteFrequencies[note];
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const filterNode = audioContext.createBiquadFilter();
            
            // Get current settings
            const waveform = document.getElementById('waveform').value;
            const detune = parseFloat(document.getElementById('detune').value);
            const filterType = document.getElementById('filterType').value;
            const cutoff = parseFloat(document.getElementById('cutoff').value);
            const resonance = parseFloat(document.getElementById('resonance').value);
            const attack = parseFloat(document.getElementById('attack').value);
            const decay = parseFloat(document.getElementById('decay').value);
            const sustain = parseFloat(document.getElementById('sustain').value);
            
            // Configure oscillator
            oscillator.type = waveform;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.detune.setValueAtTime(detune, audioContext.currentTime);
            
            // Configure filter
            filterNode.type = filterType;
            filterNode.frequency.setValueAtTime(cutoff, audioContext.currentTime);
            filterNode.Q.setValueAtTime(resonance, audioContext.currentTime);
            
            // Configure envelope
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + attack);
            gainNode.gain.linearRampToValueAtTime(sustain, audioContext.currentTime + attack + decay);
            
            // Connect audio graph
            oscillator.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(masterGain);
            
            oscillator.start();
            
            // Store active note
            activeNotes.set(note, { oscillator, gainNode });
            
            // Visual feedback
            const keyElement = document.querySelector(`[data-note="${note}"]`);
            if (keyElement) {
                keyElement.classList.add('active');
            }
        }

        // Stop note
        function stopNote(note) {
            const noteData = activeNotes.get(note);
            if (!noteData) return;
            
            const { oscillator, gainNode } = noteData;
            const release = parseFloat(document.getElementById('release').value);
            
            // Apply release envelope
            gainNode.gain.cancelScheduledValues(audioContext.currentTime);
            gainNode.gain.setValueAtTime(gainNode.gain.value, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + release);
            
            oscillator.stop(audioContext.currentTime + release);
            activeNotes.delete(note);
            
            // Remove visual feedback
            const keyElement = document.querySelector(`[data-note="${note}"]`);
            if (keyElement) {
                keyElement.classList.remove('active');
            }
        }

        // Keyboard mapping
        const keyMap = {
            'a': 'C', 'w': 'C#', 's': 'D', 'e': 'D#', 'd': 'E',
            'f': 'F', 't': 'F#', 'g': 'G', 'y': 'G#', 'h': 'A',
            'u': 'A#', 'j': 'B', 'k': 'C'
        };

        // Keyboard events
        document.addEventListener('keydown', (e) => {
            const note = keyMap[e.key.toLowerCase()];
            if (note && !e.repeat) {
                playNote(note);
            }
        });

        document.addEventListener('keyup', (e) => {
            const note = keyMap[e.key.toLowerCase()];
            if (note) {
                stopNote(note);
            }
        });

        // Control value updates
        function updateControlValues() {
            document.getElementById('detuneValue').textContent = document.getElementById('detune').value;
            document.getElementById('cutoffValue').textContent = document.getElementById('cutoff').value + ' Hz';
            document.getElementById('resonanceValue').textContent = parseFloat(document.getElementById('resonance').value).toFixed(1);
            document.getElementById('attackValue').textContent = parseFloat(document.getElementById('attack').value).toFixed(2) + 's';
            document.getElementById('decayValue').textContent = parseFloat(document.getElementById('decay').value).toFixed(2) + 's';
            document.getElementById('sustainValue').textContent = parseFloat(document.getElementById('sustain').value).toFixed(2);
            document.getElementById('releaseValue').textContent = parseFloat(document.getElementById('release').value).toFixed(2) + 's';
            document.getElementById('volumeValue').textContent = Math.round(parseFloat(document.getElementById('volume').value) * 100) + '%';
        }

        // Master volume control
        document.getElementById('volume').addEventListener('input', (e) => {
            if (masterGain) {
                masterGain.gain.value = parseFloat(e.target.value);
            }
            updateControlValues();
        });

        // Add event listeners to all controls
        ['detune', 'cutoff', 'resonance', 'attack', 'decay', 'sustain', 'release'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateControlValues);
        });

        // Waveform visualization
        function drawWaveform() {
            if (!analyser) return;
            
            requestAnimationFrame(drawWaveform);
            
            analyser.getByteTimeDomainData(dataArray);
            
            canvasCtx.fillStyle = '#000000';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
            
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = '#5D5CDE';
            canvasCtx.beginPath();
            
            const sliceWidth = canvas.width / dataArray.length;
            let x = 0;
            
            for (let i = 0; i < dataArray.length; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * canvas.height / 2;
                
                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            canvasCtx.stroke();
            
            // Grid lines
            canvasCtx.strokeStyle = '#333333';
            canvasCtx.lineWidth = 1;
            canvasCtx.beginPath();
            canvasCtx.moveTo(0, canvas.height / 2);
            canvasCtx.lineTo(canvas.width, canvas.height / 2);
            canvasCtx.stroke();
        }

        // MIDI Functionality
        let midiAccess = null;
        let selectedMidiInput = null;
        const midiNoteToKey = {
            60: 'C', 61: 'C#', 62: 'D', 63: 'D#', 64: 'E', 65: 'F',
            66: 'F#', 67: 'G', 68: 'G#', 69: 'A', 70: 'A#', 71: 'B',
            72: 'C' // C5 (octave up)
        };

        // MIDI CC mapping optimized for Native Instruments Z1
        // Z1 sends CC 1,2,3,4 on both Channel 1 and Channel 2
        const midiCCMap = {
            // Channel 1 (Z1 Channel A) - CC 1,2,3,4
            '1_1': { id: 'cutoff', min: 100, max: 8000 },      // Ch1 CC1 → Filter Cutoff
            '1_2': { id: 'resonance', min: 0.1, max: 30 },     // Ch1 CC2 → Resonance  
            '1_3': { id: 'attack', min: 0, max: 2 },           // Ch1 CC3 → Attack
            '1_4': { id: 'volume', min: 0, max: 1 },           // Ch1 CC4 → Master Volume
            
            // Channel 2 (Z1 Channel B) - CC 1,2,3,4
            '2_1': { id: 'decay', min: 0, max: 2 },            // Ch2 CC1 → Decay
            '2_2': { id: 'sustain', min: 0, max: 1 },          // Ch2 CC2 → Sustain
            '2_3': { id: 'release', min: 0, max: 3 },          // Ch2 CC3 → Release
            '2_4': { id: 'detune', min: -100, max: 100 },      // Ch2 CC4 → Detune
        };

        // Initialize MIDI
        async function initMIDI() {
            try {
                midiAccess = await navigator.requestMIDIAccess();
                updateMidiStatus('Connected', true);
                updateMidiDevices();
                
                // Listen for device changes
                midiAccess.onstatechange = updateMidiDevices;
                
            } catch (error) {
                console.error('Failed to access MIDI devices:', error);
                updateMidiStatus('Access Denied', false);
            }
        }

        // Update MIDI status display
        function updateMidiStatus(text, connected) {
            const statusElement = document.getElementById('midiStatus');
            const statusTextElement = document.getElementById('midiStatusText');
            
            statusTextElement.textContent = text;
            statusElement.className = `w-3 h-3 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`;
        }

        // Update available MIDI devices
        function updateMidiDevices() {
            const deviceSelect = document.getElementById('midiDevice');
            const inputs = Array.from(midiAccess.inputs.values());
            
            // Clear existing options
            deviceSelect.innerHTML = '';
            
            if (inputs.length === 0) {
                deviceSelect.innerHTML = '<option value="">No MIDI devices found</option>';
                deviceSelect.disabled = true;
                return;
            }
            
            deviceSelect.disabled = false;
            deviceSelect.innerHTML = '<option value="">Select a MIDI device...</option>';
            
            inputs.forEach(input => {
                const option = document.createElement('option');
                option.value = input.id;
                option.textContent = `${input.name} (${input.manufacturer || 'Unknown'})`;
                deviceSelect.appendChild(option);
            });
        }

        // Handle MIDI device selection
        function selectMidiDevice(deviceId) {
            // Disconnect from previous device
            if (selectedMidiInput) {
                selectedMidiInput.onmidimessage = null;
            }
            
            if (!deviceId) {
                selectedMidiInput = null;
                return;
            }
            
            selectedMidiInput = midiAccess.inputs.get(deviceId);
            if (selectedMidiInput) {
                selectedMidiInput.onmidimessage = handleMidiMessage;
                updateMidiStatus(`Connected to ${selectedMidiInput.name}`, true);
            }
        }

        // Convert MIDI note number to frequency
        function midiNoteToFrequency(noteNumber) {
            // MIDI note 69 (A4) = 440 Hz
            return 440 * Math.pow(2, (noteNumber - 69) / 12);
        }

        // Convert MIDI note to our note system
        function midiNoteToSynthNote(noteNumber) {
            const noteInOctave = noteNumber % 12;
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            return noteNames[noteInOctave];
        }

        // MIDI Debug Logging
        function logMidiMessage(message) {
            const [status, data1, data2] = message.data;
            const messageType = status & 0xF0;
            const channel = (status & 0x0F) + 1; // Display as 1-16
            
            let messageTypeStr = 'Unknown';
            let messageDetails = '';
            
            switch (messageType) {
                case 0x90:
                    messageTypeStr = 'Note On';
                    messageDetails = `Note: ${data1}, Velocity: ${data2}`;
                    break;
                case 0x80:
                    messageTypeStr = 'Note Off';
                    messageDetails = `Note: ${data1}, Velocity: ${data2}`;
                    break;
                case 0xB0:
                    messageTypeStr = 'Control Change';
                    messageDetails = `CC: ${data1}, Value: ${data2}`;
                    break;
                default:
                    messageDetails = `Data: ${data1}, ${data2}`;
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] Ch${channel} ${messageTypeStr} - ${messageDetails}`;
            
            const midiLog = document.getElementById('midiLog');
            midiLog.innerHTML += logEntry + '\n';
            midiLog.scrollTop = midiLog.scrollHeight;
        }

        // Handle MIDI messages
        function handleMidiMessage(message) {
            // Log all MIDI messages for debugging
            logMidiMessage(message);
            
            const [status, data1, data2] = message.data;
            const messageType = status & 0xF0;
            const channel = status & 0x0F;
            
            switch (messageType) {
                case 0x90: // Note On
                    if (data2 > 0) { // Velocity > 0
                        handleMidiNoteOn(data1, data2);
                    } else {
                        handleMidiNoteOff(data1);
                    }
                    break;
                    
                case 0x80: // Note Off
                    handleMidiNoteOff(data1);
                    break;
                    
                case 0xB0: // Control Change
                    handleMidiCC(data1, data2, channel);
                    break;
            }
        }

        // Handle MIDI note on with velocity
        function handleMidiNoteOn(noteNumber, velocity) {
            const note = midiNoteToSynthNote(noteNumber);
            const normalizedVelocity = velocity / 127;
            
            // Store original volume for velocity scaling
            if (!window.originalVolume) {
                window.originalVolume = parseFloat(document.getElementById('volume').value);
            }
            
            // Scale volume based on velocity
            const velocityVolume = window.originalVolume * normalizedVelocity;
            
            // Temporarily adjust master volume for this note
            playNoteWithVelocity(note, velocityVolume, noteNumber);
        }

        // Handle MIDI note off
        function handleMidiNoteOff(noteNumber) {
            const note = midiNoteToSynthNote(noteNumber);
            stopNote(note);
        }

        // Play note with velocity and custom frequency
        function playNoteWithVelocity(note, velocity, midiNoteNumber) {
            initAudio();
            
            const noteKey = `${note}_${midiNoteNumber}`;
            if (activeNotes.has(noteKey)) return;
            
            const frequency = midiNoteToFrequency(midiNoteNumber);
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const filterNode = audioContext.createBiquadFilter();
            
            // Get current settings
            const waveform = document.getElementById('waveform').value;
            const detune = parseFloat(document.getElementById('detune').value);
            const filterType = document.getElementById('filterType').value;
            const cutoff = parseFloat(document.getElementById('cutoff').value);
            const resonance = parseFloat(document.getElementById('resonance').value);
            const attack = parseFloat(document.getElementById('attack').value);
            const decay = parseFloat(document.getElementById('decay').value);
            const sustain = parseFloat(document.getElementById('sustain').value);
            
            // Configure oscillator
            oscillator.type = waveform;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.detune.setValueAtTime(detune, audioContext.currentTime);
            
            // Configure filter
            filterNode.type = filterType;
            filterNode.frequency.setValueAtTime(cutoff, audioContext.currentTime);
            filterNode.Q.setValueAtTime(resonance, audioContext.currentTime);
            
            // Configure envelope with velocity
            const velocityGain = velocity * 0.8; // Scale velocity
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(velocityGain, audioContext.currentTime + attack);
            gainNode.gain.linearRampToValueAtTime(velocityGain * sustain, audioContext.currentTime + attack + decay);
            
            // Connect audio graph
            oscillator.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(masterGain);
            
            oscillator.start();
            
            // Store active note with MIDI key
            activeNotes.set(noteKey, { oscillator, gainNode });
            
            // Visual feedback
            const keyElement = document.querySelector(`[data-note="${note}"]`);
            if (keyElement) {
                keyElement.classList.add('active');
            }
        }

        // Handle MIDI CC messages with channel support
        function handleMidiCC(ccNumber, ccValue, channel) {
            // Create channel+CC key for Z1 mapping
            const ccKey = `${channel + 1}_${ccNumber}`;
            const mapping = midiCCMap[ccKey];
            
            if (!mapping) return;
            
            const element = document.getElementById(mapping.id);
            if (!element) return;
            
            // Convert CC value (0-127) to parameter range
            const normalizedValue = ccValue / 127;
            const parameterValue = mapping.min + (normalizedValue * (mapping.max - mapping.min));
            
            // Update the control
            element.value = parameterValue;
            
            // Update display values
            updateControlValues();
            
            // Apply to audio if it's volume
            if (mapping.id === 'volume' && masterGain) {
                masterGain.gain.value = parameterValue;
            }
        }

        // Override stopNote for MIDI (handle the key mapping)
        const originalStopNote = stopNote;
        stopNote = function(note) {
            // First try to stop regular note
            originalStopNote(note);
            
            // Then try to stop any MIDI notes with this base note
            for (const [key, noteData] of activeNotes.entries()) {
                if (key.startsWith(note + '_')) {
                    const { oscillator, gainNode } = noteData;
                    const release = parseFloat(document.getElementById('release').value);
                    
                    gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                    gainNode.gain.setValueAtTime(gainNode.gain.value, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + release);
                    
                    oscillator.stop(audioContext.currentTime + release);
                    activeNotes.delete(key);
                }
            }
            
            // Remove visual feedback
            const keyElement = document.querySelector(`[data-note="${note}"]`);
            if (keyElement) {
                keyElement.classList.remove('active');
            }
        };

        // Event listeners for MIDI controls
        document.getElementById('midiConnect').addEventListener('click', initMIDI);
        document.getElementById('midiDevice').addEventListener('change', (e) => {
            selectMidiDevice(e.target.value);
        });
        document.getElementById('clearMidiLog').addEventListener('click', () => {
            document.getElementById('midiLog').innerHTML = 'Move Z1 knobs to see MIDI messages here...';
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createKeyboard();
            updateControlValues();
            
            // Check for MIDI support
            if (navigator.requestMIDIAccess) {
                updateMidiStatus('Available - Click to connect', false);
            } else {
                updateMidiStatus('Not supported in this browser', false);
                document.getElementById('midiConnect').disabled = true;
            }
        });
    </script>
</body>
</html>
